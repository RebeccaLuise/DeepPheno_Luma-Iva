---
title: "GG alluvial plot for genus dominance in sputum"
author: "Rebecca L. Knoll"
date: " last edit `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: show
    number_sections: yes
    smart: no
    toc: yes
    df_print: paged
    toc_float: yes
---

```{r setup 2, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache= FALSE, warning = FALSE)
```

```{r run import script, include=FALSE}
# run script to tidy the data and to load packages, create phyloseq object (ps_clean) and load libraries
ps_full<- readRDS("~/Documents/Forschung/Orkambi_Kids/Paper/DeepPheno_Luma-Iva/data/ps_orkambi_trimmed.rds")

#renv::install("pacman")
library(pacman)
p_load(tidyverse, phyloseq, magrittr, janitor, microbiome, knitr, lubridate, naniar, readxl, ggplot2, ggpubr, ggalluvial)

source("/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/IMMProveCF/functions_full.R")

# assign colors

# subset sputum providing patients

sputum_id <- c("IMP11",  "IMP13", "IMP15", "IMP16", "IMP17", "IMP24", "IMP25", "IMP26", "IMP27", "IMP29", "IMP31", "IMP32", "IMP33", "IMP35", "IMP5",  "IMP6", "IMP9",  "IMP21", "IMP8")

#dom_palette <- c(paletteer_d("ggthemes::Nuriel_Stone"))
dom_palette <- c(Streptococcus="#69b3a2", Staphylococcus = "#8175AA", Fusobacterium="#6FB899FF", Prevotella_7="#31A1B3FF", Rothia="#027B8EFF", Pseudomonas="#EE6AA7", Eikenella="#94D0C0FF", Haemophilus="#CCB22BFF", Achromobacter="#9F8F12FF", Gemella= "#97CFD0" , Moraxella= "#6FB899", `missing sample` = "#CFCFCF")

```

```{r subset per material}

# subset sputum
ps_full_sputum <- subset_samples(ps_full, material== "Sputum")

# remove zero abundances from  dataset
ps_sputum <- tax_filter(ps_full_sputum, min_prevalence = 1,
  prev_detection_threshold = 1, min_total_abundance = 0, min_sample_abundance = 0, tax_level = NA,
  names_only = FALSE, use_counts = TRUE, undetected = NULL,verbose = TRUE)

# calculate relative abundances
ps_full_relab <- transform_sample_counts(ps_full, function(x) x/sum(x))
ps_sputum_relab <- transform_sample_counts(ps_sputum, function(x) x/sum(x))

```

```{r find dominant genus; most abundant taxa per patient in sputum}

# Analysis on most abundant taxa per patient in sputum
ps_sputum_glom <- tax_glom(ps_sputum_relab, taxrank = "genus")

#Get top taxa per patient
#find.top.taxa2 is sourced from functions.R
top.sputum<- find.top.taxa2(ps_sputum_glom, "genus",1)
top.sputum$species<- NULL

rslt <- top.sputum[, "taxa"]
dd <- matrix(unlist(rslt), nrow=1)
colnames(dd) <- rownames(top.sputum)
top.sputum <- t(dd)

top.sputum_df <- data.frame(x1 = row.names(top.sputum), top.sputum)%>%
  mutate(dominantGenus = top.sputum)
top.sputum_df$top.sputum<- NULL

sample_data(ps_sputum_glom) <- data.frame(x1 = row.names(sample_data(ps_sputum_glom)), sample_data(ps_sputum_glom))
##Add dominant Genus to ps_sputum_glom sample data
ps_sputum_glom <- microViz::ps_join(ps_sputum_glom, top.sputum_df, by = "x1")
```

```{r reshape metadata for ggalluvial}

# extract metadata
full_metadata <- as(sample_data(ps_sputum_glom), "data.frame")

# pivot wider per visit_sum ( reduce first number of columns for more clearness)

full_metadata <- full_metadata %>% 
  mutate(id_visit=paste(id, visit, sep="_"))

metadata <- full_metadata%>%
  select(x1, visit, id, id_visit, dominantGenus)

m_count <- metadata%>%
  group_by(visit)%>%
  count(dominantGenus)%>%
  pivot_wider(names_from = visit, values_from = n, names_prefix = "V")

metadata_w <- metadata%>%
  pivot_wider(names_from = visit, values_from = dominantGenus, names_prefix = "V")%>%
  mutate(n_observation = c(1:32))

metadata_w%>%count(V2)

metadata_w2 <- metadata%>%
  select(-c(x1, id_visit))%>%
  pivot_wider(names_from = visit, values_from = dominantGenus, names_prefix = "V")%>%
  group_by(id) %>% 
  summarise(across(everything(), ~ max(., na.rm = T)))%>% # merges the rows of same id patients
  mutate(domGenus = factor(V1, levels=c("Streptococcus", "Staphylococcus", "Eikenella", "Haemophilus", "`missing sample`")))
  

```

```{r alluvial plot}

# display only samples with sputum , id 8 had no sputum sample at any timepoint

#in order to have each visits per patient in my dataframe, even if they had no sampling conducted at that timepoint, I need to add a dummie row for it

visit_fictional <- c(1:9)
id <- c(1:7)

vist_fic_df <- merge(id, visit_fictional)%>%
  mutate(id_visit =  paste(x, y, sep="_"))%>%
  distinct(id_visit, .keep_all = T)

metadata_fic <- metadata%>%
  filter(id!="8")%>%
  right_join(vist_fic_df, by="id_visit")%>%
  mutate(dominantGenus_new = as_factor(case_when(is.na(dominantGenus) ~ "missing sample")))%>%
  mutate(dominantGenus_new = as_factor(coalesce(dominantGenus, dominantGenus_new)))%>%
  mutate(visit=as_factor(y))

# for alluvial format I now have to remove the "double" visit 8

#id_rm <- c("IMP29V9","IMP5V9", "IMP6V8", "IMP8V8", "IMP21V9", "IMP25V9", "IMP11V8", "IMP26V9", "IMP24V9", "IMP27V9", "IMP33V9", "IMP9V9")

#renv::install("ggalluvial")
library(ggalluvial)

metadata_fic%>%
  filter(visit!="8") %>% 
  ggplot(aes(x = visit, stratum = dominantGenus_new, alluvium = x,
           fill =dominantGenus_new, label=id)) +
  scale_fill_manual(values= dom_palette,guide =
                         guide_legend(label.theme = element_text(angle = 0, face = "italic", size = 16)))+
  geom_lode() + 
  geom_flow(curve_type = "arctangent",width = .3, color="black") +
  geom_stratum(alpha = 0.6)+
  theme_pubr()+
  theme(legend.position="right", text = element_text(size=20))+
  labs(fill="Dominant genus in sputum")+
  labs(x="visit")+
  labs(y = "n samples")#+
  scale_x_discrete(labels=c("0", "3","6","9","12","15","18","21-24"))
  
ggsave("/Users/rebecca/Documents/Forschung/Orkambi_Kids/Paper/alluvial_dominantGenus.pdf", width = 12, height = 7)

metadata_fic%>%
  filter(id=="1") %>% 
  filter(visit!="8") %>% 
  ggplot(aes(x = visit, stratum = dominantGenus_new, alluvium = x,
           fill =dominantGenus_new, label=id)) +
  scale_fill_manual(values= dom_palette,guide =
                         guide_legend(label.theme = element_text(angle = 0, face = "italic", size = 16)))+
  geom_lode() + 
  geom_flow(curve_type = "arctangent",width = .3, color="black") +
  geom_stratum(alpha = 0.6)+
  theme_pubr()+
  theme(legend.position="right", text = element_text(size=20))+
  labs(fill="Dominant genus in sputum")+
  labs(x="visit")+
  labs(y = "n samples")#+
  scale_x_discrete(labels=c("0", "3","6","9","12","15","18","21-24"))



```

```{r other options}

metadata_fic%>%
  #filter(!id_visit%in%id_rm)%>%
  ggplot(aes(x = visit, stratum = dominantGenus_new, alluvium = x,
           fill =dominantGenus_new)) +
  scale_fill_manual(values= dom_palette)+
  #scale_color_manual(values=sputum_palette)+
  geom_lode() + 
  geom_alluvium(aes(fill="grey"),curve_type = "arctangent")+
  #geom_flow(aes(color=id.y),curve_type = "arctangent",width = .4, color="black") +
  geom_stratum(alpha = 0.5)#+
  #geom_line(aes(group=x))+
  #geom_text(stat = "stratum", aes(label = dominantGenus_new))#round(after_stat(prop*100), 0),
                #hjust = (after_stat(stratum) == "to")))

metadata_w2%>%
  ggplot(aes(axis1=V1, axis2 = V2, axis3=V3, axis4=V4, axis5=V5, axis6=V6, axis7=V7, axis8=V9))+
  geom_alluvium(aes(fill=V1))+
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = paste(after_stat(stratum))))

metadata_w2%>%
  ggplot(aes(axis1=V1, axis2 = V2, axis3=V3, axis4=V4, axis5=V5, axis6=V6, axis7=V7, axis8=V9))+
  geom_alluvium(aes(fill="grey"))+
  geom_stratum(aes(fill=domGenus)) +
  geom_text(stat = "stratum", aes(label = paste(after_stat(stratum))))+
  scale_fill_manual(values= dom_palette)#+
  scale_fill_manual(values=sputum_palette)

metadata_fic %>% 
  filter(!is.na(id)) %>% 
  filter(visit!="8") %>% 
  ggplot(aes(x=visit, fill=dominantGenus_new))+
  geom_bar()+
  facet_wrap(~id)
  
```

